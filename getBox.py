import cv2, numpy
import json

from func import *

#note
# structures =[{'4': [4.035564853556485, 0.014965792474344356, 0.19270308405563394, 0.040621436716077534], 'page': [0.0, 0.0, 1.0, 1.0], '5': [0.5247328848436882, 0.014965792474344356, 0.5093731102600282, 0.040621436716077534], '2': [0.1251063829787234, 0.1912770809578107, 0.236847409796412, 0.7773660205245154], 'edge': [0.030354852501068834, 0.014110604332953249, 0.9429550493852046, 0.955387685290764], 'QR': [5.207621550591327, 0.06841505131128849, 0.15339649264261238, 0.10846636259977195], '3': [0.03149775016070281, 0.05629988597491448, 0.9407377544849829, 0.13426453819840364], '6': [0.125, 0.014965792474344356, 0.23704898206006852, 0.040621436716077534], '1': [0.38055635216518496, 0.1912770809578107, 0.7028824833702882, 0.7773660205245154]}, {'': [0.38055635216518496, 0.014965792474344356, 0.7028824833702882, 0.9660775370581528], 'edge': [0.030354852501068834, 0.014110604332953249, 0.9429550493852046, 0.9677879133409351], 'QR': [1.0, -0.00014253135689851768, -0.00020157226365652087, -0.00014253135689851768], 'page': [0.0, 0.0, 1.0, 1.0], '8': [0.1251063829787234, 0.014965792474344356, 0.236847409796412, 0.9660775370581528]}]

#note_alt
# structures =[{'4': [-0.06264501160092807, -0.37587006960556846, 1.1090487238979119, 0.33178654292343385], 'page': [-4.538283062645012, -0.4965197215777262, 5.756380510440835, 8.139211136890951], 'edge': [-4.373549883990719, -0.382830626450116, 5.426914153132251, 7.7772621809744775], 'QR': [0.0, 0.0, 1.0, 1.0], '1': [-3.0, 1.060324825986079, 4.046403712296984, 6.327146171693736], '6': [-4.368909512761021, -0.37587006960556846, 1.3665893271461718, 0.33178654292343385], '5': [-3.0, -0.37587006960556846, 2.9327146171693736, 0.33178654292343385], '2': [-4.368909512761021, 1.060324825986079, 1.3642691415313226, 6.327146171693736], '3': [-4.368909512761021, -0.03944315545243619, 5.4153132250580045, 1.0951276102088168]}, {'page': [-1.0, -1.0, -2481.0, -3508.0], 'edge': [-72.0, -50.0, -2339.0, -3396.0], '7': [-664.0, -53.0, -1744.0, -3390.0], 'QR': [-0.0, -0.0, 1.0, 1.0], '8': [-74.0, -53.0, -588.0, -3390.0]}]
structures =[{'page': [-5.207621550591327, -0.6307490144546649, 6.519053876478318, 9.219448094612352], '6': [-5.014454664914586, -0.492772667542707, 1.545335085413929, 0.3745072273324573], 'QR': [0.0, 0.0, 1.0, 1.0], '2': [-5.014454664914586, 1.1327201051248357, 1.5440210249671484, 7.16688567674113], 'edge': [-5.021024967148489, -0.5006570302233903, 6.147174770039422, 8.80814717477004], '3': [-5.014454664914586, -0.1116951379763469, 6.132720105124836, 1.2378449408672798], '1': [-3.463863337713535, 1.1327201051248357, 4.582128777923785, 7.16688567674113], '5': [-3.4651773981603156, -0.492772667542707, 3.320630749014455, 0.3745072273324573], '4': [-0.13797634691195795, -0.492772667542707, 1.2562417871222076, 0.3745072273324573]}, {'page': [-1.0, -1.0, -4961.0, -7016.0], '7': [-148.0, -106.0, -1175.0, -6778.0], 'QR': [-0.0, -0.0, 1.0, 1.0], 'edge': [-143.0, -100.0, -4678.0, -6790.0]}]

mode=0

page=cv2.imread('cache/t11.jpg')
# page=cv2.imread('xxx.jpg')

# page=cv2.imread('cache/page_0.jpg')


pageGray=cv2.cvtColor(page,cv2.COLOR_BGR2GRAY)
xc, yc, wc, hc = locateQR(pageGray.copy(), returnArray=0)  # x (QR)code, y (QR)code
hp, wp,Chanel = page.shape  # hp height of page, wp width of page

print([xc, yc, wc, hc])
if mode==0:
    for name, part in structures[0].items():
        x, y, w, h = part

        page2 = page.copy()
        x, y, w, h = [int(x * wc) + xc, int(y * hc) + yc, int(w * wc), int(h * hc)]
        cv2.rectangle(page2, (x, y), (x + w, y + h), (0, 255, 0), 5)

        print(name)
        print(part)
        print([x, y, w, h])
        print("\n")
        viewPage(page2, resizeFactor=0.175)


elif mode==1:
    print(1)
elif mode==2:
    for name, part in structures[0].items():
        x,y,w,h=part


        # position=[int(x*wc)+xc,int(y*hc)+yc,int(w*wc),int(h*hc)]
        # crop=cropImg(page,position)
        # viewPage(crop)

        page2=page.copy()
        x,y,w,h=[int(x*wc)+xc,int(y*hc)+yc,int(w*wc),int(h*hc)]
        cv2.rectangle(page2, (x, y), (x + w, y + h), (0, 255, 0), 5)

        print(name)
        print(part)
        print([x,y,w,h])
        print("\n")
        viewPage(page2,resizeFactor=0.175)
else:
    raise Exception("error")